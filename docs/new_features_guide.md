# 新功能说明书：完整工作流自动识别与选择

## 1. 功能概述

本功能旨在优化完整工作流，使其能够自动识别 `source` 文件夹下的mod子目录，并提供交互式选择界面供用户选取其中一个mod文件夹执行后续操作。该功能支持多种目录结构，具备完善的错误处理机制，并提供明确的用户指引和操作反馈。

## 2. 可交互的CLI界面设计与实现规范

### 2.1 命令结构

```
python main.py workflow workflow
```

### 2.2 参数定义

| 参数名称 | 类型 | 描述 | 默认值 | 是否必填 |
|---------|------|------|--------|----------|
| --test-mode | str | 测试模式，使用逗号分隔的数字序列模拟用户输入 | None | 否 |
| subcommand | str | 工作流子命令，可选值：generate-rules, update-rules, workflow | 否 | 否 |

### 2.3 用户交互流程

```
===========================================
               ModLocale
===========================================
请选择操作模式：
1. Extract模式(仅提取字符串，默认简洁模式)
2. Extend模式(执行映射流程，默认简洁模式)
3. Decompile模式(执行JAR文件反编译/提取)
4. 文件管理模式(文件夹创建、重命名、备份恢复)
5. 映射规则管理（生成/更新/冲突检测）
6. 运行完整工作流
===========================================
输入数字(1/2/3/4/5/6，直接回车默认选1)：6

==========================================
        完整工作流 - 操作选择
==========================================
请选择完整工作流操作：
1. 生成翻译规则
2. 更新翻译规则
3. 运行完整工作流
0. 返回上一级菜单
==========================================
输入数字(0-3，直接回车默认选1)：3

执行配置：
模式：完整工作流
流程：运行完整工作流
===========================================
[INFO] 正在自动识别可用的mod文件夹...

==========================================
        可用mod文件夹列表
==========================================
找到 5 个可用的mod文件夹：
==========================================
1. Quality Captains 高质量舰长 1.7.0 (语言: Chinese)
   路径: C:\Users\Roki\Documents\GitHub\Tool\File\source\Chinese\Quality Captains 高质量舰长 1.7.0
2. Second-in-Command 舰队副官 1.7.0 (语言: Chinese)
   路径: C:\Users\Roki\Documents\GitHub\Tool\File\source\Chinese\Second-in-Command 舰队副官 1.7.0
3. Quality Captains 1.7.0 (语言: English)
   路径: C:\Users\Roki\Documents\GitHub\Tool\File\source\English\Quality Captains 1.7.0
4. Second-in-Command 1.7.0 (语言: English)
   路径: C:\Users\Roki\Documents\GitHub\Tool\File\source\English\Second-in-Command 1.7.0
5. TestMod 1.0.0 (语言: English)
   路径: C:\Users\Roki\Documents\GitHub\Tool\File\source\English\TestMod 1.0.0
0. 返回上一级菜单
==========================================
请选择一个mod文件夹（输入数字，直接回车默认选1）：

==========================================
        已选择mod文件夹
==========================================
名称: Quality Captains 高质量舰长 1.7.0
语言: Chinese
路径: C:\Users\Roki\Documents\GitHub\Tool\File\source\Chinese\Quality Captains 高质量舰长 1.7.0
==========================================
是否确认选择？(y/n，默认y)：
[INFO] 自动生成输出目录：C:\Users\Roki\Documents\GitHub\Tool\File\output\Workflow_Quality Captains 高质量舰长 1.7.0
是否使用双语src文件夹自动生成规则？(y/n，默认n)：
```

### 2.4 错误处理机制

| 错误类型 | 错误信息 | 处理方式 |
|---------|---------|----------|
| 目录不存在 | `[ERROR] source目录不存在: {source_path}` | 返回上一级菜单 |
| 权限不足 | `[ERROR] 权限不足，无法访问目录` | 返回上一级菜单 |
| 没有可用mod文件夹 | `[ERROR] 未找到任何mod文件夹` | 返回上一级菜单 |
| 输入无效 | `[ERROR] 输入无效，请输入1-{len(mod_folders)}之间的数字` | 重新提示用户输入 |
| 选择取消 | 无 | 返回上一级菜单 |

### 2.5 界面展示效果

1. **主菜单**：清晰展示所有可用操作模式
2. **子菜单**：展示完整工作流的所有可用操作
3. **mod文件夹列表**：以清晰的列表形式展示所有可用的mod文件夹，包含名称、语言和路径信息
4. **选择确认**：显示用户选择的mod文件夹信息，并要求用户确认
5. **操作反馈**：显示自动生成的输出目录和双语src文件夹路径
6. **错误提示**：提供明确的错误信息和解决建议

## 3. 技术实现

### 3.1 核心函数

#### 3.1.1 `select_mod_folder()`

**功能**：自动识别source文件夹下的mod子目录，并提供交互式选择界面

**参数**：无

**返回值**：
- `str`：用户选择的mod文件夹路径，若取消则返回空字符串

**实现细节**：
1. 从配置中获取source目录路径
2. 检查source目录是否存在
3. 遍历source目录下的所有语言子文件夹
4. 遍历语言子文件夹下的所有文件夹，直接识别mod文件夹
5. 以清晰的列表形式呈现给用户
6. 提供交互式选择界面
7. 处理异常情况

#### 3.1.2 `run_workflow_sub_flow(sub_flow, base_path)`

**功能**：运行完整工作流子流程

**参数**：
- `sub_flow`：子流程类型
- `base_path`：基础路径

**返回值**：
- `dict`：处理结果

**实现细节**：
1. 在"运行完整工作流"子流程中调用`select_mod_folder()`函数
2. 获取用户选择的mod文件夹
3. 自动生成输出目录路径
4. 自动识别双语src文件夹路径
5. 使用该文件夹路径执行后续操作

### 3.2 目录结构支持

该功能支持以下目录结构：

1. **标准结构**：`source/{language}/{mod_name}`
   - 示例：`source/English/Quality Captains 1.7.0`

2. **传统结构**：`source/{language}/mod/{mod_name}`
   - 示例：`source/English/mod/Quality Captains 1.7.0`

### 3.3 错误处理

该功能具备完善的错误处理机制，能够处理以下异常情况：

1. **目录不存在**：处理source目录或语言子文件夹不存在的情况
2. **权限不足**：处理无法访问目录的情况
3. **没有可用mod文件夹**：处理未找到任何mod文件夹的情况
4. **输入无效**：处理用户输入无效的情况
5. **选择取消**：处理用户取消选择的情况

## 4. 用户指引

### 4.1 操作步骤

1. 运行程序：`python main.py`
2. 选择操作模式：输入"6"（运行完整工作流）
3. 选择完整工作流操作：输入"3"（运行完整工作流）
4. 选择mod文件夹：从列表中选择一个mod文件夹，输入对应的数字
5. 确认选择：输入"y"或直接回车确认选择
6. 选择是否使用双语src文件夹：输入"y"或"n"，或直接回车使用默认值
7. 等待程序执行完成

### 4.2 操作反馈

1. **自动识别反馈**：显示"正在自动识别可用的mod文件夹..."
2. **mod文件夹列表**：显示所有可用的mod文件夹
3. **选择确认**：显示用户选择的mod文件夹信息
4. **自动生成输出目录**：显示自动生成的输出目录路径
5. **双语src文件夹识别**：显示自动识别的双语src文件夹路径
6. **执行结果**：显示执行结果和输出路径

## 5. 测试与验证

### 5.1 测试用例

| 测试用例 | 预期结果 | 实际结果 |
|---------|----------|----------|
| 正常目录结构 | 成功识别所有mod文件夹 | ✅ |
| 空source目录 | 显示错误信息，返回上一级菜单 | ✅ |
| 权限不足 | 显示错误信息，返回上一级菜单 | ✅ |
| 无效输入 | 重新提示用户输入 | ✅ |
| 取消选择 | 返回上一级菜单 | ✅ |

### 5.2 验证方法

1. 手动运行程序，执行完整工作流
2. 使用不同的目录结构测试
3. 测试各种异常情况
4. 验证错误处理机制
5. 验证用户交互流程

## 6. 扩展与维护

### 6.1 扩展建议

1. 支持更多目录结构
2. 添加mod文件夹过滤功能
3. 支持多选mod文件夹
4. 添加mod文件夹搜索功能
5. 支持自定义输出目录

### 6.2 维护建议

1. 定期更新目录结构支持
2. 优化错误处理机制
3. 改进用户界面
4. 添加更多调试信息
5. 完善测试用例

## 7. 总结

本功能优化了完整工作流，使其能够自动识别source文件夹下的mod子目录，并提供交互式选择界面供用户选取其中一个mod文件夹执行后续操作。该功能支持多种目录结构，具备完善的错误处理机制，并提供明确的用户指引和操作反馈。通过本功能，用户可以更便捷地执行完整工作流，提高工作效率。

---

**文档版本**：1.0.0
**创建日期**：2025-12-17
**更新日期**：2025-12-17
**作者**：ModLocale开发团队
