# Localization Tool重构计划

## 一、项目现状分析

1. **现有模块结构**：
   - `init_mode`：负责初始化操作，包括文件夹创建、重命名、映射构建等
   - `extract_mode`：负责字符串提取功能
   - `extend_mode`：负责字符串映射功能
   - `decompile_mode`：负责JAR文件反编译功能
   - `common`：包含公共工具函数

2. **当前功能实现**：
   - 已完成文件夹结构创建
   - 已完成mod文件夹自动重命名
   - 已完成mod映射关系构建
   - 已完成从备份恢复文件

3. **待实现功能**：
   - 文件夹标记分组功能
   - 用户可选功能模块集成
   - 多文件夹并行处理支持
   - 优化输出文件管理

## 二、重构目标

1. **模块化设计**：确保各模块职责单一，高内聚低耦合
2. **性能优化**：支持多文件夹并行处理，提高处理效率
3. **可维护性**：统一代码风格，完善文档
4. **扩展性**：便于后续功能扩展
5. **用户体验**：提供友好的用户交互和清晰的输出管理

## 三、重构步骤

### 步骤1：验证现有init_mode功能

1. **测试文件夹创建功能**：
   - 验证REQUIRED_FOLDERS中定义的所有文件夹是否能正确创建
   - 测试已存在文件夹的处理逻辑

2. **测试自动重命名功能**：
   - 测试mod_info.json读取和解析
   - 测试文件夹重命名逻辑
   - 验证id_to_mod_info_mapping映射表构建

3. **测试备份恢复功能**：
   - 验证从source_backup到source的文件恢复
   - 测试不同场景下的恢复逻辑

4. **测试mod映射构建**：
   - 验证mod_mappings全局映射表的构建
   - 测试get_mod_path_by_id等查询函数

### 步骤2：开发文件夹标记分组功能

1. **设计标记系统**：
   - 在init_mode中添加文件夹标记逻辑
   - 为source和rule目录下的文件夹建立唯一标识
   - 实现文件夹预分组管理

2. **实现分组映射**：
   - 扩展mod_mappings结构，添加分组信息
   - 实现基于mod_id的分组匹配机制
   - 避免后续流程中重新分析mod_info.json

3. **优化映射关系存储**：
   - 确保映射关系持久化，便于后续功能使用
   - 实现映射关系的高效查询接口

### 步骤3：开发用户可选功能模块

1. **集成extract_mode功能**：
   - 实现5.1功能：调用extract_mode提取字符串并生成规则文件和报告
   - 支持多文件夹并行处理
   - 确保输出文件自动复制到对应rule目录

2. **集成extend_mode功能**：
   - 实现5.2功能：使用rule目录下的规则文件进行字符串映射
   - 支持多文件夹并行处理
   - 生成相应的报告文档

3. **集成decompile_mode功能**：
   - 实现5.3功能：反编译JAR文件获取src文件夹，然后调用extract_mode
   - 支持多文件夹并行处理
   - 生成相应的报告文档

### 步骤4：优化输出文件管理

1. **统一输出目录结构**：
   - 确保规则文件和报告文档自动输出到output目录下的对应语言子文件夹
   - 实现输出文件的自动复制机制，将规则文件复制到rule目录对应位置

2. **优化规则文件使用机制**：
   - 确保extend_mode仅使用rule目录下对应语言对应mod文件夹中的规则文件
   - 实现规则文件版本控制和验证

### 步骤5：支持多文件夹并行处理

1. **设计并行处理框架**：
   - 利用Python多进程或多线程实现并行处理
   - 确保线程安全，避免资源竞争

2. **实现任务分配机制**：
   - 根据mod数量动态分配处理任务
   - 实现任务进度跟踪和状态管理

3. **优化资源使用**：
   - 合理设置并行度，避免系统资源耗尽
   - 实现任务超时处理机制

## 四、代码优化

1. **统一代码风格**：
   - 严格遵循PEP 8规范
   - 统一缩进、命名规范
   - 添加必要的注释和文档字符串

2. **优化错误处理**：
   - 完善异常处理机制
   - 提供清晰的错误信息
   - 实现错误恢复机制

3. **提高代码可测试性**：
   - 设计可测试的函数接口
   - 编写单元测试和集成测试
   - 实现测试覆盖率统计

## 五、测试策略

1. **单元测试**：
   - 测试每个函数的基本功能
   - 测试边界条件和异常情况
   - 测试性能和内存使用

2. **集成测试**：
   - 测试模块间的交互
   - 测试完整的工作流程
   - 测试不同场景下的系统行为

3. **回归测试**：
   - 确保重构不会破坏现有功能
   - 验证新功能与现有功能的兼容性

## 六、交付物

1. **重构后的代码**：
   - 优化后的init_mode模块
   - 集成的用户可选功能模块
   - 支持多文件夹并行处理
   - 优化的输出文件管理

2. **测试报告**：
   - 单元测试结果
   - 集成测试结果
   - 性能测试结果

3. **文档更新**：
   - 模块功能文档
   - API接口文档
   - 使用说明文档

## 七、实施时间表

- **步骤1**：验证现有init_mode功能（1天）
- **步骤2**：开发文件夹标记分组功能（2天）
- **步骤3**：开发用户可选功能模块（3天）
- **步骤4**：优化输出文件管理（1天）
- **步骤5**：支持多文件夹并行处理（2天）
- **步骤6**：代码优化和测试（2天）

总计：11天

## 八、风险评估

1. **性能风险**：多文件夹并行处理可能导致系统资源耗尽
   - 应对措施：合理设置并行度，实现资源监控和动态调整

2. **兼容性风险**：重构可能破坏现有功能
   - 应对措施：完善的回归测试，渐进式重构

3. **数据安全风险**：文件操作可能导致数据丢失
   - 应对措施：完善的备份机制，操作前验证，异常回滚

4. **复杂度风险**：功能集成可能导致代码复杂度增加
   - 应对措施：严格的模块化设计，清晰的代码结构，完善的文档

## 九、预期收益

1. **提高处理效率**：支持多文件夹并行处理，减少处理时间
2. **增强系统稳定性**：完善的错误处理和恢复机制
3. **提高代码可维护性**：清晰的模块化设计，统一的代码风格
4. **提升用户体验**：友好的用户交互，清晰的输出管理
5. **便于后续扩展**：模块化设计便于添加新功能

## 十、技术选型

1. **并行处理**：Python multiprocessing模块
2. **配置管理**：使用现有的config_utils模块
3. **日志管理**：使用现有的logger_utils模块
4. **测试框架**：pytest
5. **文档生成**：sphinx

## 十一、重构原则

1. **单一职责原则**：每个模块只负责一个功能领域
2. **开放封闭原则**：对扩展开放，对修改封闭
3. **依赖倒置原则**：依赖于抽象，不依赖于具体实现
4. **接口隔离原则**：使用多个专门的接口，而不是一个统一的接口
5. **里氏替换原则**：子类可以替换父类，而不影响程序的正确性

## 十二、质量保证

1. **代码审查**：确保代码符合规范和设计要求
2. **测试覆盖**：确保测试覆盖率达到80%以上
3. **性能测试**：确保系统性能满足要求
4. **安全性测试**：确保系统安全可靠
5. **用户验收测试**：确保系统满足用户需求

## 十三、后续维护计划

1. **定期更新**：根据用户反馈和需求变化，定期更新系统
2. **性能优化**：持续优化系统性能
3. **功能扩展**：根据需要添加新功能
4. **文档更新**：保持文档与代码同步
5. **社区支持**：提供技术支持和培训

以上是Localization Tool的详细重构计划，通过本次重构，将使系统更加模块化、高效、可维护和可扩展，为后续功能扩展和性能优化奠定基础。